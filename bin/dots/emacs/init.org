#+TITLE: Emacs Configuration
#+AUTHOR: Adam Cooper
#+OPTIONS: toc:nil
#+PROPERTY: header-args:emacs-lisp :tangle init.el

* Initialization

** org-auto-tangle
#+begin_src emacs-lisp
(use-package! org-auto-tangle
  :hook (org-mode . org-auto-tangle-mode)
  :config
  (setq org-auto-tangle-default t))
#+end_src

** Emacs version check
#+BEGIN_SRC emacs-lisp
(when (< emacs-major-version 29)
  (error "Emacs Writing Studio requires version 29 or later"))
#+END_SRC

** Package archives
#+BEGIN_SRC emacs-lisp
(use-package package
  :config
  (add-to-list 'package-archives
               '("melpa" . "https://melpa.org/packages/"))
  (package-initialize))
#+END_SRC

** Package management
#+BEGIN_SRC emacs-lisp
(use-package use-package
  :custom
  (use-package-always-ensure t)
  (package-native-compile t)
  (warning-minimum-level :emergency))
#+END_SRC

** Load EWS functions
#+BEGIN_SRC emacs-lisp
(load-file (concat (file-name-as-directory user-emacs-directory)
                   "ews.el"))
#+END_SRC

** Check for missing executables
#+BEGIN_SRC emacs-lisp
(ews-missing-executables
 '(("gs" "mutool")
   ;; "pdftotext"
   ;; "soffice"
   "zip"
   ;; "ddjvu"
   "curl"
   ("mpg321" "ogg123" "mplayer" "mpv" "vlc")
   ("grep" "ripgrep")
   ("convert" "gm")
   "dvipng"
   "latex"
   "hunspell"
   "git"))
#+END_SRC

* Look and Feel

** Basic UI
#+BEGIN_SRC emacs-lisp
(setq inhibit-splash-screen t)
(tool-bar-mode -1)
(menu-bar-mode -1)
(scroll-bar-mode -1)
#+END_SRC

** Short answers
#+BEGIN_SRC emacs-lisp
(setq-default use-short-answers t)
#+END_SRC

** Scratch buffer
#+BEGIN_SRC emacs-lisp
(setq initial-major-mode 'org-mode
      initial-scratch-message (concat "#+title: Emacs Writing Studio\n"
                                      "#+subtitle: Scratch Buffer\n\n"
                                      "The text in this buffer is not saved "
                                      "when exiting Emacs!\n\n"))
#+END_SRC

** Spacious padding
#+BEGIN_SRC emacs-lisp
(use-package spacious-padding
  :custom
  (line-spacing 3)
  (spacious-padding-mode 1))
#+END_SRC

** Themes

*** Modus Themes
#+BEGIN_SRC emacs-lisp
(use-package modus-themes
  :custom
  (modus-themes-italic-constructs t)
  (modus-themes-bold-constructs t)
  (modus-themes-mixed-fonts t)
  (modus-themes-to-toggle '(modus-operandi-tinted
                            modus-vivendi-tinted))
  :bind
  (("C-c w t t" . modus-themes-toggle)
   ("C-c w t m" . modus-themes-select)
   ("C-c w t s" . consult-theme)))
#+END_SRC

*** EF Themes
#+BEGIN_SRC emacs-lisp
(use-package ef-themes)
#+END_SRC

** Mixed-pitch mode
#+BEGIN_SRC emacs-lisp
(use-package mixed-pitch
  :hook
  (org-mode . mixed-pitch-mode))
#+END_SRC

** Window management
#+BEGIN_SRC emacs-lisp
(setq split-width-threshold 120
      split-height-threshold nil)

(use-package balanced-windows
  :config
  (balanced-windows-mode))
#+END_SRC

* Minibuffer Completion

** Vertico
#+BEGIN_SRC emacs-lisp
(use-package vertico
  :init
  (vertico-mode)
  :custom
  (vertico-sort-function 'vertico-sort-history-alpha))
#+END_SRC

** Savehist
#+BEGIN_SRC emacs-lisp
(use-package savehist
  :init
  (savehist-mode))
#+END_SRC

** Orderless
#+BEGIN_SRC emacs-lisp
(use-package orderless
  :custom
  (completion-styles '(orderless basic))
  (completion-category-defaults nil)
  (completion-category-overrides
   '((file (styles partial-completion)))))
#+END_SRC

** Marginalia
#+BEGIN_SRC emacs-lisp
(use-package marginalia
  :init
  (marginalia-mode))
#+END_SRC

** Which-key
#+BEGIN_SRC emacs-lisp
(use-package which-key
  :config
  (which-key-mode)
  :custom
  (which-key-max-description-length 40)
  (which-key-lighter nil)
  (which-key-sort-order 'which-key-description-order)
  :init
  (which-key-add-key-based-replacements
    "C-c w"   "Emacs Writing Studio"
    "C-c w b" "Bibliographic"
    "C-c w d" "Denote"
    "C-c w m" "Multimedia"
    "C-c w s" "Spelling and Grammar"
    "C-c w t" "Themes"
    "C-c w x" "Explore"))
#+END_SRC

** Context menu
#+BEGIN_SRC emacs-lisp
(when (display-graphic-p)
  (context-menu-mode))
#+END_SRC

** Helpful
#+BEGIN_SRC emacs-lisp
(use-package helpful
  :bind
  (("C-h f" . helpful-function)
   ("C-h x" . helpful-command)
   ("C-h k" . helpful-key)
   ("C-h v" . helpful-variable)))
#+END_SRC

* Text Mode Enhancements

** Text mode basics
#+BEGIN_SRC emacs-lisp
(use-package text-mode
  :ensure nil
  :hook
  (text-mode . visual-line-mode)
  :init
  (delete-selection-mode t)
  :custom
  (sentence-end-double-space nil)
  (scroll-error-top-bottom t)
  (save-interprogram-paste-before-kill t))
#+END_SRC

** Flyspell
#+BEGIN_SRC emacs-lisp
(use-package flyspell
  :custom
  (ispell-program-name "hunspell")
  (ispell-dictionary ews-hunspell-dictionaries)
  (flyspell-mark-duplications-flag nil)
  (org-fold-core-style 'overlays)
  :config
  (ispell-set-spellchecker-params)
  (ispell-hunspell-add-multi-dic ews-hunspell-dictionaries)
  :hook
  (text-mode . flyspell-mode)
  :bind
  (("C-c w s s" . ispell)
   ("C-;"       . flyspell-auto-correct-previous-word)))
#+END_SRC

* Org Mode Enhancements

** Basic Org settings
#+BEGIN_SRC emacs-lisp
(use-package org
  :custom
  (org-startup-indented t)
  (org-hide-emphasis-markers t)
  (org-startup-with-inline-images t)
  (org-image-actual-width '(450))
  (org-pretty-entities t)
  (org-use-sub-superscripts "{}")
  (org-id-link-to-org-use-id t)
  (org-fold-catch-invisible-edits 'show))
#+END_SRC

** Org-appear
#+BEGIN_SRC emacs-lisp
(use-package org-appear
  :hook
  (org-mode . org-appear-mode))
#+END_SRC

** Org-fragtog
#+BEGIN_SRC emacs-lisp
(use-package org-fragtog
  :after org
  :hook
  (org-mode . org-fragtog-mode)
  :custom
  (org-startup-with-latex-preview nil)
  (org-format-latex-options
   (plist-put org-format-latex-options :scale 2)
   (plist-put org-format-latex-options :foreground 'auto)
   (plist-put org-format-latex-options :background 'auto)))
#+END_SRC

** Org-modern
#+BEGIN_SRC emacs-lisp
(use-package org-modern
  :hook
  (org-mode . org-modern-mode)
  :custom
  (org-modern-table nil)
  (org-modern-keyword nil)
  (org-modern-timestamp nil)
  (org-modern-priority nil)
  (org-modern-checkbox nil)
  (org-modern-tag nil)
  (org-modern-block-name nil)
  (org-modern-footnote nil)
  (org-modern-internal-target nil)
  (org-modern-radio-target nil)
  (org-modern-statistics nil)
  (org-modern-progress nil))
#+END_SRC

* Multimedia, Notes, Bibliography, and Denote

** Doc-View
#+BEGIN_SRC emacs-lisp
(use-package doc-view
  :custom
  (doc-view-resolution 300)
  (large-file-warning-threshold (* 50 (expt 2 20))))
#+END_SRC

** ePub support
#+BEGIN_SRC emacs-lisp
(use-package nov
  :init
  (add-to-list 'auto-mode-alist '("\\.epub\\'" . nov-mode)))
#+END_SRC

** Bibliography
*** BibTeX
#+BEGIN_SRC emacs-lisp
(use-package bibtex
  :custom
  (bibtex-user-optional-fields
   '(("keywords" "Keywords to describe the entry" "")
     ("file"     "Relative or absolute path to attachments" "" )))
  (bibtex-align-at-equal-sign t)
  :config
  (ews-bibtex-register)
  :bind
  (("C-c w b r" . ews-bibtex-register)))
#+END_SRC

*** Biblio
#+BEGIN_SRC emacs-lisp
(use-package biblio
  :bind
  (("C-c w b b" . ews-bibtex-biblio-lookup)))
#+END_SRC

*** Citar
#+BEGIN_SRC emacs-lisp
(use-package citar
  :defer t
  :custom
  (citar-bibliography ews-bibtex-files)
  :bind
  (("C-c w b o" . citar-open)))
#+END_SRC

** RSS with Elfeed
#+BEGIN_SRC emacs-lisp
(use-package elfeed
  :custom
  (elfeed-db-directory
   (expand-file-name "elfeed" user-emacs-directory))
  (elfeed-show-entry-switch 'display-buffer)
  :bind
  ("C-c w e" . elfeed))

(use-package elfeed-org
  :config
  (elfeed-org)
  :custom
  (rmh-elfeed-org-files
   (list (concat (file-name-as-directory (getenv "HOME"))
                 "elfeed.org"))))
#+END_SRC

** Org-web-tools
#+BEGIN_SRC emacs-lisp
(use-package org-web-tools
  :bind
  (("C-c w w" . org-web-tools-insert-link-for-url)))
#+END_SRC

** EMMS
#+BEGIN_SRC emacs-lisp
(use-package emms
  :config
  (require 'emms-setup)
  (require 'emms-mpris)
  (emms-all)
  (emms-default-players)
  (emms-mpris-enable)
  :custom
  (emms-browser-covers #'emms-browser-cache-thumbnail-async)
  :bind
  (("C-c w m b" . emms-browser)
   ("C-c w m e" . emms)
   ("C-c w m p" . emms-play-playlist )
   ("<XF86AudioPrev>" . emms-previous)
   ("<XF86AudioNext>" . emms-next)
   ("<XF86AudioPlay>" . emms-pause)))
#+END_SRC

* Denote and Notes Management

** Denote
#+BEGIN_SRC emacs-lisp
(use-package denote
  :defer t
  :custom
  (denote-sort-keywords t)
  (denote-link-description-function #'ews-denote-link-description-title-case)
  (denote-rename-buffer-mode 1)
  :hook
  (dired-mode . denote-dired-mode)
  :custom-face
  (denote-faces-link ((t (:slant italic))))
  :bind
  (("C-c w d b" . denote-find-backlink)
   ("C-c w d d" . denote-date)
   ("C-c w d l" . denote-find-link)
   ("C-c w d i" . denote-link-or-create)
   ("C-c w d k" . denote-rename-file-keywords)
   ("C-c w d n" . denote)
   ("C-c w d r" . denote-rename-file)
   ("C-c w d R" . denote-rename-file-using-front-matter)))
#+END_SRC

** Denote auxiliary packages
#+BEGIN_SRC emacs-lisp
(use-package denote-journal)
(use-package denote-org
  :bind
  (("C-c w d h" . denote-org-link-to-heading)))
(use-package denote-sequence)
#+END_SRC

** Consult and Notes
#+BEGIN_SRC emacs-lisp
(use-package consult
  :bind
  (("C-c w h" . consult-org-heading)
   ("C-c w g" . consult-grep))
  :config
  (add-to-list 'consult-preview-allowed-hooks 'visual-line-mode))

(use-package consult-notes
  :custom
  (consult-notes-denote-display-keywords-indicator "_")
  :bind
  (("C-c w d f" . consult-notes)
   ("C-c w d g" . consult-notes-search-in-all-notes))
  :init
  (consult-notes-denote-mode))
#+END_SRC

** Citar-Denote
#+BEGIN_SRC emacs-lisp
(use-package citar-denote
  :custom
  (citar-open-always-create-notes t)
  :init
  (citar-denote-mode)
  :bind
  (("C-c w b c" . citar-create-note)
   ("C-c w b n" . citar-denote-open-note)
   ("C-c w b x" . citar-denote-nocite)
   :map org-mode-map
   ("C-c w b k" . citar-denote-add-citekey)
   ("C-c w b K" . citar-denote-remove-citekey)
   ("C-c w b d" . citar-denote-dwim)
   ("C-c w b e" . citar-denote-open-reference-entry)))
#+END_SRC

** Denote Explore
#+BEGIN_SRC emacs-lisp
(use-package denote-explore
  :bind
  (;; Statistics
   ("C-c w x c" . denote-explore-count-notes)
   ("C-c w x C" . denote-explore-count-keywords)
   ("C-c w x b" . denote-explore-barchart-keywords)
   ("C-c w x e" . denote-explore-barchart-filetypes)
   ;; Random walks
   ("C-c w x r" . denote-explore-random-note)
   ("C-c w x l" . denote-explore-random-link)
   ("C-c w x k" . denote-explore-random-keyword)
   ("C-c w x x" . denote-explore-random-regex)
   ;; Denote Janitor
   ("C-c w x d" . denote-explore-identify-duplicate-notes)
   ("C-c w x z" . denote-explore-zero-keywords)
   ("C-c w x s" . denote-explore-single-keywords)
   ("C-c w x o" . denote-explore-sort-keywords)
   ("C-c w x w" . denote-explore-rename-keyword)
   ;; Visualise denote
   ("C-c w x n" . denote-explore-network)
   ("C-c w x v" . denote-explore-network-regenerate)
   ("C-c w x D" . denote-explore-barchart-degree)))
#+END_SRC

* Org Export, Capture, and Publishing

** Org Capture templates
#+BEGIN_SRC emacs-lisp
(use-package org
  :bind
  (("C-c c" . org-capture)
   ("C-c l" . org-store-link))
  :custom
  (org-capture-templates
   '(("f" "Fleeting note"
      item
      (file+headline org-default-notes-file "Notes")
      "- %?")
     ("p" "Permanent note" plain
      (file denote-last-path)
      #'denote-org-capture
      :no-save t
      :immediate-finish nil
      :kill-buffer t
      :jump-to-captured t)
     ("t" "New task" entry
      (file+headline org-default-notes-file "Tasks")
      "* TODO %i%?"))))
#+END_SRC
